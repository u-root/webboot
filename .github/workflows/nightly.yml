name: nightly
on:
  # Triggers the workflow every day at 23:00.
  schedule:
    - cron: '0 23 * * *'

  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

# A workflow run is made up of one or more jobs that can run sequentially or in
# parallel.
jobs:
  # This job will build the linux kernel.
  buildKernel:
    runs-on: ubuntu-latest 
    # Set the working directory to the correct place in $GOPATH.
    defaults:
      run:
        working-directory: ${{ env.GOPATH }}/src/github.com/${{ github.repository }}
    # Environment variables
    env:
      # GOPATH is the current directory.
      GOPATH: ${{ github.workspace }}
      # Turn off modules because they are broken.
      GO111MODULE: off
    steps:
      - name: Checkout code
        uses: actions/checkout@v2
        with:
          path: ${{ env.GOPATH }}/src/github.com/${{ github.repository }}
      - name: Kernel Build
        run: |
          ./nightly.sh
      - name: Checkout code
        uses: actions/checkout@v2
        with:
          path: ${{ env.GOPATH }}/src/github.com/${{ github.repository }}
      - uses: actions/upload-artifact@master
        with:
          name: nightly-kernel-build
          path: linux/arch/x86/boot/bzImage
  
  # This job will run the matrix of distros.
  runDistros:
    needs: buildKernel
    runs-on: ubuntu-latest
    # Set the working directory to the correct place in $GOPATH.
    defaults:
      run:
        working-directory: ${{ env.GOPATH }}/src/github.com/${{ github.repository }}
    # Environment variables
    env:
      # GOPATH is the current directory.
      GOPATH: ${{ github.workspace }}
      # Turn off modules because they are broken.
      GO111MODULE: off
      WEBBOOT_DISTRO: ${{ matrix.distro }}
    strategy:
      matrix:
        distro:
          - Arch
          - CentOS 7
          - CentOS 8
          - Debian
          - Fedora
          - Kali
          - Linux Mint
          - Manjaro
          - Tinycore
          - LHSCowboys
          - DHSGaels
          - Ubuntu
    # Steps represent a sequence of tasks that will be executed as part of the
    # job
    steps:
      - uses: actions/download-artifact@master
        with:
          name: nightly-kernel-build
          path: linux/arch/x86/boot/bzImage
      - name: Install Go
        uses: actions/setup-go@v2
        with:
          go-version: 1.16.x
      - name: Checkout code
        uses: actions/checkout@v2
        with:
          path: ${{ env.GOPATH }}/src/github.com/${{ github.repository }}
      - name: Checkout dependencies
        run: |
          ./firsttime.sh
      - name: Test TestScript
        run: |
          go test -v ./integration
